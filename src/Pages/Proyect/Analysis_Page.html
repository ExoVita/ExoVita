<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Light Curve Metadata Form</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500&display=swap" rel="stylesheet">

  <style>
    /* Fondo de la página con la imagen */
    body{
      font-family:'Orbitron', sans-serif;
      margin:0;
      min-height:100vh;
      background:url('https://live.staticflickr.com/2227/1615827228_cde78ce693_b.jpg') center/cover no-repeat fixed;
      color:#f0f3ff;
    }

    /* ====== BARRA SUPERIOR (copiada tal cual) ====== */
    #navbar{
      position:absolute;
      top:0;
      left:0;
      width:100%;
      opacity:.75;
      height:9vh;
      background-color:#0a1016; /* azul marino */
      z-index:15;
      display:flex;
      align-items:center;
      padding-left:2vw;
      font-family:'Orbitron', sans-serif;
    }
    #navbar-text{
      font-size:1.5rem;
      color:#fff;
      font-weight:bold;
    }

    /* ===== CONTENIDO ===== */
    /* empuja el contenido por debajo de la barra de 9vh */
    .page-overlay{ margin-top:10vh; }

    h1{
      text-align:center;
      color:#fff;
      text-shadow:0 2px 6px rgba(0,0,0,.5);
      margin:10px auto 20px;
      max-width:800px;
      font-size:clamp(28px, 3.5vw + 8px, 56px);
    }

    .form-container{
      background:rgba(13,2,121,.9);
      backdrop-filter:blur(3px);
      padding:20px;
      border-radius:8px;
      box-shadow:0 8px 24px rgba(0,0,0,.25);
      max-width:800px;
      margin:0 auto 30px;
      color:#eef2ff;
    }

    .form-group{ margin-bottom:15px; }

    .form-group label{
      font-weight:700;
      display:block;
      color:#eef2ff;
    }

    .form-group input,
    .form-group select,
    .form-group textarea{
      width:100%;
      padding:8px;
      border:1px solid #353e6d;
      border-radius:4px;
      font-size:14px;
      box-sizing:border-box;
      background:rgba(30,30,54,.96);
      color:#aaa9ad;
    }

    .form-group input::placeholder,
    .form-group textarea::placeholder{
      color:#6b7280;
      font-family:'Orbitron', sans-serif;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus{
      outline:2px solid #8ea2ff;
      border-color:#8ea2ff;
      box-shadow:0 0 0 2px rgba(142,162,255,.25);
    }

    .form-group textarea{ height:100px; resize:vertical; }

    /* Botón consistente para <button> y <a> */
    .submit-btn{
      background-color:#2e02a7;
      color:#ffffff;
      padding:10px 20px;
      border:none;
      border-radius:4px;
      font-size:16px;
      cursor:pointer;
      width:100%;
      font-family:'Orbitron', sans-serif;

      display:block;
      text-align:center;
      text-decoration:none;
      box-sizing:border-box; /* evita overflow por padding */
    }
    .submit-btn:hover{ background-color:#1105bb; }
    .submit-btn:link,
    .submit-btn:visited{ color:#ffffff; }
    .submit-btn:focus-visible{
      outline:2px solid #8ea2ff;
      box-shadow:0 0 0 2px rgba(142,162,255,.25);
    }
  </style>
</head>

<body>
  <!-- NAVBAR replicada -->
  <div id="navbar">
    <span id="navbar-text">Exoplanet Detection Model</span>
  </div>

  <!-- CONTENIDO -->
  <div class="page-overlay">
    <h1>Light Curve Metadata Form</h1>

    <div class="form-container">
      <form id="metadataForm" action="#" method="post" enctype="multipart/form-data" novalidate>
        <!-- Identification Section -->
        <div class="form-group">
          <label for="source_id">Mission Name</label>
          <input type="text" id="source_id" name="source_id" required pattern="[A-Za-z0-9-]+" placeholder="e.g., Kepler-10">
        </div>

        <div class="form-group">
          <label for="star_name">Optional</label>
          <input type="text" id="star_name" name="star_name" pattern="[A-Za-z0-9\s\-]+" title="Alphanumeric characters and spaces only." placeholder="KIC 1234567">
        </div>

        <div class="form-group">
          <label for="observer_team">Name of the Observer/Team</label>
          <input type="text" id="observer_team" name="observer_team" required pattern="[A-Za-z0-9\s\-]+" placeholder="Quetzalcode Team">
        </div>

        <!-- Light Curve Metadata Section -->
        <div class="form-group">
          <label for="period_days">Period of the Star in Days</label>
          <input type="number" step="any" id="period_days" name="period_days" required min="0.01" placeholder="e.g., 3.72">
        </div>

        <div class="form-group">
          <label for="epoch_bjd">Epoch of the Transit in BJD</label>
          <input type="number" step="any" id="epoch_bjd" name="epoch_bjd" required min="0" placeholder="e.g., 2457000.1234">
        </div>

        <div class="form-group">
          <label for="flux_rel">Is the Light Curve Normalized?</label>
          <select id="flux_rel" name="flux_rel" required>
            <option value="Yes">Yes</option>
            <option value="No">No</option>
          </select>
        </div>

        <div class="form-group">
          <label for="flux_err_index">Error Index or Method</label>
          <input type="text" id="flux_err_index" name="flux_err_index" required pattern="[A-Za-z0-9\s\-]+" placeholder="e.g., MAD, RMS, pipeline_v2">
        </div>

        <div class="form-group">
          <label for="orbit_guess">Orbit Assumption</label>
          <select id="orbit_guess" name="orbit_guess" required>
            <option value="Circular">Circular</option>
            <option value="Elongated">Elongated</option>
            <option value="Unknown">Unknown</option>
          </select>
        </div>

        <!-- Quality / Rules Section -->
        <div class="form-group">
          <label for="time_unit">Time Unit Used</label>
          <select id="time_unit" name="time_unit" required>
            <option value="BJD">BJD</option>
            <option value="TJD">TJD</option>
            <option value="HJD">HJD</option>
            <option value="MJD">MJD</option>
          </select>
        </div>

        <div class="form-group">
          <label for="missing_values">Count of Missing Values</label>
          <input type="number" id="missing_values" name="missing_values" min="0" placeholder="0">
        </div>

        <div class="form-group">
          <label for="quality_flags">Data Quality Status</label>
          <select id="quality_flags" name="quality_flags" required>
            <option value="OK">OK</option>
            <option value="Warning">Warning</option>
            <option value="Bad">Bad</option>
          </select>
        </div>

        <div class="form-group">
          <label for="ephemeris_window">Time Window for Ephemerides</label>
          <input type="text" id="ephemeris_window" name="ephemeris_window" pattern="[A-Za-z0-9\s\-]+" placeholder="e.g., ±0.05 days">
        </div>

        <div class="form-group">
          <label for="outliers_handling">Method for Handling Outliers</label>
          <input type="text" id="outliers_handling" name="outliers_handling" pattern="[A-Za-z0-9\s\-]+" placeholder="e.g., sigma_clip(5σ)">
        </div>

        <div class="form-group">
          <label for="known_outliers">List of Known Outliers</label>
          <input type="text" id="known_outliers" name="known_outliers" pattern="[A-Za-z0-9\s\-]+" placeholder="e.g., flares, reaction_wheel">
        </div>

        <div class="form-group">
          <label for="notes">Additional Notes</label>
          <textarea id="notes" name="notes" pattern="[A-Za-z0-9\s\-]}" placeholder="Any relevant context..."></textarea>
        </div>

        <!-- Light Curve File Section -->
        <div class="form-group">
          <label for="curve_file">CSV File with Columns: 'time', 'flux', 'flux_err'</label>
          <input type="file" id="curve_file" name="curve_file" accept=".csv" required>
        </div>

        <!-- Submit Button -->
        <div class="form-group">
          <button type="submit" class="submit-btn">Submit</button>
        </div>

        <div class="form-group">
          <a class="submit-btn" href="../Home_Proyect.html">Back to Home</a>
        </div>
      </form>
    </div>
  </div>
  <!-- Footer -->
  <footer>
    <div>© 2025 ExoVita - NASA Space App Challenge</div>
  </footer>
  <script>
    // Quita "required" de todos los campos del formulario
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('#metadataForm [required]').forEach(el => {
        el.removeAttribute('required');
      });
    });
  </script>

  <script>
    (function () {
      const WEBHOOK_URL = 'https://hook.us2.make.com/jsx7tw6aaff345ec6w9cmv4uvo3mkcyf';

      // Orden de los 15 campos (string #1 .. #15)
      const FIELD_IDS_IN_ORDER = [
        'source_id',          // 1
        'star_name',          // 2
        'observer_team',      // 3
        'period_days',        // 4
        'epoch_bjd',          // 5
        'flux_rel',           // 6
        'flux_err_index',     // 7
        'orbit_guess',        // 8
        'time_unit',          // 9
        'missing_values',     //10
        'quality_flags',      //11
        'ephemeris_window',   //12
        'outliers_handling',  //13
        'known_outliers',     //14
        'notes'               //15
      ];

      const form = document.getElementById('metadataForm');
      const submitBtn = form.querySelector('button[type="submit"]');
      const csvInput = document.getElementById('curve_file');

      function valueOrNA(el) {
        if (!el) return 'not available';
        const v = (typeof el.value === 'string') ? el.value.trim() : '';
        return v === '' ? 'not available' : String(v);
      }

      // Convierte CSV -> Array<Array<string>> -> string (JSON)
      async function csvFileToArrayString(file) {
        if (!file) return 'not available'; // si no hay archivo
        const nameIsCsv = file.name && file.name.toLowerCase().endsWith('.csv');
        const typeIsCsv = file.type === 'text/csv' || file.type === 'application/vnd.ms-excel' || file.type === '';
        if (!nameIsCsv && !typeIsCsv) return 'not available'; // formato desconocido

        try {
          const text = await file.text();
          const lines = text
            .split(/\r?\n/)
            .map(l => l.trim())
            .filter(l => l.length > 0);
          if (lines.length === 0) return 'not available';
          const array2D = lines.map(line => line.split(','));
          return JSON.stringify(array2D);
        } catch (e) {
          console.error('Error leyendo CSV:', e);
          return 'not available';
        }
      }

      async function handleSubmit(e) {
        e.preventDefault();

        // 1) Toma los primeros 15 strings, usando "not available" si faltan
        const first15Strings = FIELD_IDS_IN_ORDER.map(id => valueOrNA(document.getElementById(id)));

        // 2) Lee CSV si existe; si no, manda "not available" como string #16
        const file = csvInput && csvInput.files ? csvInput.files[0] : null;
        const csvString16 = await csvFileToArrayString(file);

        // 3) Arreglo final de 16 strings
        const payloadArrayOf16Strings = [...first15Strings, csvString16];

        // 4) Envío a Make como { strings: [...] }
        const payload = { strings: payloadArrayOf16Strings };

        submitBtn.disabled = true;
        submitBtn.textContent = 'Enviando...';

        try {
          const resp = await fetch(WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const respText = await resp.text(); // por si Make regresa texto
          if (!resp.ok) throw new Error(`HTTP ${resp.status}: ${respText || 'Error en el webhook'}`);
          alert('¡Datos enviados!');
          form.reset();
        } catch (err) {
          console.error(err);
          alert('Error al enviar. Revisa la consola.');
        } finally {
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit';
        }
      }

      form.addEventListener('submit', handleSubmit);
    })();
  </script>


</body>
</html>
