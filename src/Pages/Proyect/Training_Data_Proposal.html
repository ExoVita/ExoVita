<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Training_Data_Proposal — Upload CSV</title>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500&display=swap" rel="stylesheet">
  <style>
    :root{ --ink:#ffffff; --accent:#0c1790; }
    body{
      font-family:'Orbitron',sans-serif; color:var(--ink);
      padding:40px 20px; text-align:center;
      background-image:url('https://img.freepik.com/vector-gratis/fondo-cielo-espacial-acuarela-pintada-mano_1048-19009.jpg?semt=ais_incoming&w=740&q=80');
      background-size:cover; background-position:center; min-height:100vh;
    }
    h1{ font-size:2.2rem; margin:80 0 18px; }
    h2{ color: transparent;}
    .uploader{ margin:0 auto; max-width:900px; background:rgba(43,58,89,.9); border-radius:20px; box-shadow:0 10px 30px rgba(0,0,0,.35); padding:24px; text-align:left; }
    .drop{
      background:rgba(0,0,0,.25); border:2px dashed rgba(255,255,255,.35); border-radius:14px; padding:28px;
      display:flex; flex-direction:column; gap:10px; justify-content:center; align-items:center; min-height:200px;
      text-align:center; transition:border-color .2s ease, background .2s ease;
    }
    .drop.dragover{ border-color:#86c5ff; background:rgba(0,0,0,.35); }
    .drop input[type="file"]{ display:none; }
    .btn{ background:var(--accent); color:#c2cde7; padding:10px 16px; border:none; border-radius:10px; cursor:pointer; }
    .meta{ font-size:12px; opacity:.9; }
    .status{ margin-top:14px; font-size:14px; line-height:1.3; }
    .bar{ width:100%; height:10px; background:rgba(255,255,255,.15); border-radius:999px; overflow:hidden; margin-top:8px; }
    .bar > i{ display:block; height:100%; width:0%; background:linear-gradient(90deg,#86c5ff,#cfe6ff); transition:width .2s ease; }
    /* Barra superior azul marino */
        #navbar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 9vh;
            background-color: #0a1016;
            z-index: 15;
            display: flex;
            align-items: center;
            padding-left: 2vw;
            font-family: 'Orbitron', sans-serif;
        }

        #navbar-text {
            font-size: 1.5rem;
            color: white;
            font-weight: bold;
        }
        .button {
        display: inline-block;
        padding: 10px 25px; /* Reduced padding */
        background-color: #0c439b;
        color: white;
        font-family: 'Orbitron', sans-serif;
        font-size: 16px; /* Reduced font size */
        text-decoration: none;
        text-align: center;
        border-radius: 8px;
        border: 2px solid #ffffff;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        cursor: pointer;
        transition: all 0.3s ease;
        margin: 0 auto; /* Center the button */
        display: block; /* Make the button a block element for centering */
        margin-bottom: 20px; /* Added bottom margin for space */
        margin-top: 20px
    }
    .button:hover {
        background-color: #0b3873;
    }
    .button:active {
        background-color: #082a57;
    }
  </style>
</head>
<body>
    <!-- NAVBAR replicada -->
  <div id="navbar">
    <span id="navbar-text">Exoplanet Detection Model</span>
  </div>
  <h2>Upload Light Curve CSV</h2>

  <h1>Upload Light Curve CSV</h1>

  <div class="uploader">
    <div class="drop" id="dropzone">
      <div>Drag & drop your <b>.csv</b> here</div>
      <div class="meta">or</div>
      <label class="btn" for="fileInput">Choose CSV</label>
      <input id="fileInput" type="file" accept=".csv,text/csv" />
      <div id="fileInfo" class="meta"></div>

      <div class="status" id="status" style="display:none;">
        <div id="statusText">Preparing…</div>
        <div class="bar"><i id="barFill"></i></div>
        <div class="meta" id="skipInfo"></div>
      </div>
    </div>
  </div>
  <h2>Upload Light Curve CSV</h2>
  <a href="../Home_Proyect.html">
      <button class="button">Back to Menu</button>
  </a>
  <!-- Footer -->
  <footer>
    <div>© 2025 ExoVita - NASA Space App Challenge</div>
  </footer>

  <script>
    // ======= Config =======
    const MAKE_URL = "https://hook.us2.make.com/vea5359q7c4xv7g6ol8xmfytfgp53rv1";
    const DROP_FIRST_N_LINES = 53; // elimina filas 1..53 (1-based). Empieza desde la 54.

    // ======= DOM =======
    const dropzone   = document.getElementById('dropzone');
    const fileInput  = document.getElementById('fileInput');
    const fileInfo   = document.getElementById('fileInfo');
    const statusBox  = document.getElementById('status');
    const statusText = document.getElementById('statusText');
    const barFill    = document.getElementById('barFill');
    const skipInfo   = document.getElementById('skipInfo');

    // ======= CSV helpers =======
    function normalizeToLines(text){
      const lines = text.replace(/\r\n?/g, "\n").split("\n");
      while (lines.length && lines[lines.length-1].trim() === "") lines.pop();
      return lines;
    }

    // Parser robusto de UNA fila CSV → array de columnas (respeta comillas)
    function parseCsvRow(rowText){
      const out = [];
      let cur = "", inQ = false;
      for (let i=0;i<rowText.length;i++){
        const ch = rowText[i];
        if (inQ){
          if (ch === '"'){
            if (rowText[i+1] === '"'){ cur += '"'; i++; } // escape ""
            else inQ = false;
          } else cur += ch;
        } else {
          if (ch === '"'){ inQ = true; }
          else if (ch === ','){ out.push(cur); cur = ""; }
          else cur += ch;
        }
      }
      out.push(cur);
      return out;
    }

    function showStatus(show){
      statusBox.style.display = show ? 'block' : 'none';
      if (!show) barFill.style.width = '0%';
    }
    function updateProgress(done, total){
      const pct = total ? Math.min(100, Math.round(100 * done / total)) : 0;
      barFill.style.width = pct + "%";
      statusText.textContent = `Sending row ${done}/${total} (${pct}%)`;
    }

    // ======= Envío por FILA (todas sus columnas) =======
    async function sendRow({fileName, rowIndex, totalRows, cols, rowText, isLastRow}){
      const payload = {
        fileName,         // nombre del archivo
        rowIndex,         // índice 1-based DESPUÉS del skip
        totalRows,        // total de filas que sí se envían (post-skip)
        isLastRow,        // bool
        cols,             // ARRAY con cada columna de la fila
        rowText           // la fila completa como string (por si quieres pegarla tal cual)
      };
      const res = await fetch(MAKE_URL, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
    }

    async function processAndSend(allLines, fileName){
      // 1) eliminar filas 1..DROP_FIRST_N_LINES
      const skipped = Math.min(DROP_FIRST_N_LINES, allLines.length);
      const lines = allLines.slice(skipped);               // filas a enviar
      const total = lines.length;

      showStatus(true);
      skipInfo.textContent = `Skipped first ${skipped} line(s).`;
      fileInfo.textContent = `${fileName} • total ${allLines.length.toLocaleString()} rows • sending ${total.toLocaleString()} rows`;

      if (!total){ alert("No rows to send after skipping."); return; }

      // 2) Enviar una petición por CADA FILA con TODAS SUS COLUMNAS
      let sent = 0;
      for (let i=0; i<total; i++){
        const rowText = lines[i];
        const cols = parseCsvRow(rowText); // columnas de esta fila
        await sendRow({
          fileName,
          rowIndex: i + 1,                // 1-based dentro del bloque post-skip
          totalRows: total,
          isLastRow: i === total - 1,
          cols,
          rowText
        });
        sent = i + 1;
        updateProgress(sent, total);
      }
      statusText.textContent = `Done • Sent ${sent.toLocaleString()} rows ✅`;
    }

    function readCSVFile(file){
      const reader = new FileReader();
      reader.onload = async () => {
        try{
          const allLines = normalizeToLines(reader.result || "");
          if (!allLines.length){ alert("Empty CSV"); return; }
          await processAndSend(allLines, file.name);
        }catch(err){
          console.error(err);
          alert("Error sending CSV ❌ — check the console");
          showStatus(false);
        }
      };
      reader.onerror = () => alert("Error reading file");
      reader.readAsText(file);
    }

    // Drag & Drop
    ['dragenter','dragover'].forEach(evt=>{
      dropzone.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); dropzone.classList.add('dragover'); });
    });
    ['dragleave','drop'].forEach(evt=>{
      dropzone.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); dropzone.classList.remove('dragover'); });
    });
    dropzone.addEventListener('drop', e=>{
      const file = e.dataTransfer.files && e.dataTransfer.files[0];
      if (file && /\.csv$/i.test(file.name)) readCSVFile(file);
      else if (file) alert("Please drop a .csv file");
    });

    // File picker
    fileInput.addEventListener('change', e=>{
      const file = e.target.files && e.target.files[0];
      if (file) readCSVFile(file);
    });
  </script>
</body>
</html>
